<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<title>Geofencing可用性テスト</title>
<style>
.iframe-wrap {
  position: relative;
  width: 100%;
  padding: calc(854 / 854 * 100%) 0 0;
}
 
.iframe-wrap iframe {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
}


.hide{
    display:none;
}
</style>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
<script>
(function ($) {
    $.extend({
        geo: {
            distance:
                function (coordinate1, coordinate2) {
                    var radian = function (degree) { return degree * Math.PI / 180; }
                    var Rx = 6378137.000; // 長半径
                    var Ry = 6356752.314140356; // 短半径
                    var E2 = (Rx**2 - Ry**2) / Rx**2; // 離心率**2
                    var lat1, lat2;
                    var Dy = (lat1 = radian(coordinate1[0])) - (lat2 = radian(coordinate2[0])); // 緯度差
                    var Dx = radian(coordinate1[1]) - radian(coordinate2[1]); // 軽度差
                    var P = (lat1 + lat2) / 2; // 中点緯度
                    var W = Math.sqrt(1 - E2 * (Math.sin(P)**2));
                    var M = Rx * (1 - E2) / W**3; // 子午線曲率半径
                    var N = Rx / W; // 卯酉線曲率半径
                    return Math.sqrt((Dy * M) ** 2 + (Dx * N * Math.cos(P)) ** 2);
                },
            _coordsApplySuccess:
                function (position) {
                    var coords = position.coords;
                    if (!this.funcs) return;
                    for (var i in this.funcs) {
                        this.funcs[i](coords.latitude, coords.longitude);
                    }
                },
            _coordsApplyError:
                function (error) {
                    /*
                    console.log('Unable to retrieve your location');
                    console.log(error);
                    */
                },
            coordsApply:
                function () {
                    //navigator.geolocation.watchPosition(
                    navigator.geolocation.getCurrentPosition(
                        $.geo._coordsApplySuccess.bind({funcs: arguments}),
                        $.geo._coordsApplyError,
                        {
                            enableHighAccuracy: true,
                            timeout: Infinity,
                            maximumAge: 0,

                        }
                    );
                },
        },
    });
})(jQuery);
</script>
<script>
jQuery(function ($) {
    $('section:gt(0)').hide();
    // 基準位置指定
    $('#init').on('click', function (event) {
        stopMeasure();
        $.geo.coordsApply(
            function (lat, lng) {
                $('#init_lat').text(lat);
                $('#init_lng').text(lng);
                $('.hide').show();
                $('#measure').text(caption.start);
            },
            Map,
            function () {
                $('section:eq(0)').hide();
                $('section:eq(1)').show();
            }
        );
    });

    var caption = {
        start: "テスト開始",
        stop: "テスト停止",
    }

    $('#measure').on('click', function (event) {
        count = 0;
        stopMeasure();
        if ($('#measure').text() == caption.start) {
            $('#measure').text(caption.stop);
            startMeasure();
        } else {
            $('#measure').text(caption.start);
        }
    });


    var t = null;
    var count = 0;
    var last_lat = null, last_lng = null, last_distance = null;

    function stopMeasure()
    {
        if (t) {
            clearTimeout(t);
            t = null;
        }
    }

    function startMeasure()
    {
        stopMeasure();
        //$('#count').text(++count + '回目');
        $.geo.coordsApply(Measure);
        t = setTimeout(startMeasure, 3000);
    }

    function Measure(lat, lng)
    {
        if (!lat || !lng || (lat === last_lat && lng === last_lng)) {
            return;
        }
        last_lat = lat;
        last_lng = lng;
        var plat = parseFloat($('#init_lat').text());
        var plng = parseFloat($('#init_lng').text());
        var distance =
            Math.floor(
                $.geo.distance([plat, plng], [lat, lng])
            );
        if (!distance || distance === last_distance) {
            return;
        }
        last_distance = distance;
        if (distance <= $('#radius').val()) {
            $('#distance').parent().css({backgroundColor: '#ccffcc'});
            $('#distance').html('拠点中心から <strong>' + distance + 'm</strong> 打刻適正エリアです');
        } else {
            $('#distance').parent().css({backgroundColor: '#ffffcc'});
            $('#distance').html('打刻適正エリアまで後 <strong>' + (distance - $('#radius').val() ) + 'm</strong> です');
        }
        Map(lat, lng, plat, plng);
    }
    function Map(lat, lng, plat=null, plng=null)
    {
        plat = plat || lat;
        plng = plng || lng;
        $("#map").attr({
            src: "http://maps.google.co.jp/maps"
                    + "?output=embed"
                    + "&ll=" + plat + "," + plng
                    + "&q=" + lat + "," + lng
                    + "&z=18"
                    + "&hl=ja"
        });
    }
    $('#radius').on('change', function (event) {
        $('#radius_output').text($(this).val() + 'm');
    });
});
</script>
</head>
<body>
<h2>Geofencingテスト</h2>

<section>
    <p>
    テストのため拠点の中心を決めます。<br />
    <strong>[基準位置取得]</strong>をタップして下さい。
    </p>
    <div><button id="init">基準位置取得</button></div>
</section>

<section>
    <p class="hide">
    (緯度:<span id="init_lat"></span> 経度:<span id="init_lng"></span>) を拠点中央とみなします。<br />
    <strong>[テスト開始]</strong>をタップして、この画面を表示したまま移動して、意図した範囲が打刻可能エリアと認識されるか確認して下さい。<br />
    <strong>[打刻可能半径]</strong>を変更することも出来ます。
        <div>
            <button class="hide" id="measure">テスト開始</button>
            <span></span>
        </div>
    </p>
    <div>
        <label for="radius">打刻可能半径: </label>
        <input type="range" name="radius" id="radius" min="10" max="300" step="10" value="30">
        <output id="radius_output" for="radius">30m</output>
    </div>
    <div class="hide"><span id="distance"></span></div>
    <div class="iframe-wrap">
        <iframe class="hide" id="map" width="640" height="700" frameborder="0" allowfullscreen></iframe>
    </div>
</section>

<section>
</section>
</body>
</html>
