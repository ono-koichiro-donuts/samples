<html>
<head>
<title>Sample of watchPosition 2</title>
<script>
export const initGeolocationWatcher = (userOptions = {}) => {
  const options = {
    geoOptions: { enableHighAccuracy: true, timeout: 10000 },
    fallbackInterval: 20000,
    maxSilence: 60000,
    onUpdate: () => {},
    onError: () => {},
    domContentFallback: true,
    ...userOptions,
  };

  let watchId = null;
  let timerId = null;
  let lastUpdated = 0;
  let lastPointerdown = 0;
  let needsRestart = false;

  const start = () => {
    if (watchId !== null) navigator.geolocation.clearWatch(watchId);

    watchId = navigator.geolocation.watchPosition(
      pos => {
        lastUpdated = Date.now();
        options.onUpdate(pos);
      },
      err => {
        options.onError(err);
        handleError(err);
      },
      options.geoOptions
    );

    if (!timerId) {
      timerId = setInterval(checkSilence, options.fallbackInterval);
    }

    console.info("[GeolocationWatcher] watchPosition started");
  };

  const stop = () => {
    if (watchId !== null) navigator.geolocation.clearWatch(watchId);
    watchId = null;

    if (timerId !== null) clearInterval(timerId);
    timerId = null;
  };

  const restart = (reason = "再起動") => {
    stop();
    start();
    console.info(`[GeolocationWatcher] ${reason}`);
  };

  const checkSilence = () => {
    if (Date.now() - lastUpdated > options.maxSilence) {
      needsRestart = true;
      console.info("[GeolocationWatcher] 沈黙検知: 再起動を pointerdown に defer");
    }
  };

  const handleError = err => {
    console.warn("[GeolocationWatcher] 位置情報エラー:", err);

    if (err.code === 1) {
      promptRecovery("位置情報の利用が拒否されました。再開しますか？");
    } else {
      console.info("[GeolocationWatcher] 一時的エラー。watch は継続");
    }
  };

  const promptRecovery = (message = "位置情報の取得に失敗しました。再開しますか？") => {
    if (window.confirm(message)) restart("ユーザー同意による再起動");
  };

  // pointerdown: getCurrentPosition + 状態次第で restart（スロットル付き）
  document.addEventListener("pointerdown", () => {
    const now = Date.now();
    const deltaTap = now - lastPointerdown;
    const deltaSilence = now - lastUpdated;

    if (deltaTap < 5000) return; // スロットル: 5秒
    lastPointerdown = now;

    // 即時現在地取得（打刻用）
    navigator.geolocation.getCurrentPosition(
      pos => {
        console.info("[GeolocationWatcher] pointerdown により getCurrentPosition 成功");
        options.onUpdate(pos);
      },
      err => {
        console.warn("[GeolocationWatcher] pointerdown の getCurrentPosition 失敗:", err);
      },
      options.geoOptions
    );

    if (needsRestart || deltaSilence > options.maxSilence) {
      restart("pointerdown による沈黙復旧");
      needsRestart = false;
    }
  });

  if (options.domContentFallback) {
    document.addEventListener("DOMContentLoaded", () => {
      start();
      setTimeout(() => {
        if (lastUpdated === 0) showStartButton();
      }, 5000);
    });
  }

  const showStartButton = () => {
    const btn = document.createElement("button");
    btn.textContent = "位置情報取得を開始";
    btn.onclick = () => {
      start();
      btn.remove();
    };
    document.body.appendChild(btn);
  };

  return { start, stop };
};

const geolocation = navigator.geolocation;
let count = 0;

const success = (position) => {
    const coords = position.coords;
    document.getElementById('count').innerHTML = count++;
    document.getElementById('lat').innerHTML = coords.latitude;
    document.getElementById('lnd').innerHTML = coords.longitude;
}
const log = (message = "") => {
    const error = document.getElementById("error");
    const div = document.createElement("div"); 
    div.textContent = `count=${count}: ${message}`;
    error.insertBefore(div, error.querySelector("div"));
}

function startValidate(timeout)
{
    timeout = timeout || 5000;
    //disableAditItem();
    //areaInfo(Measuring, message_measuring);
    initGeolocationWatcher({
        onUpdate: success,
        onError: log,
        geoOptions: {
            enableHighAccuracy: false,
            timeout,
            maximumAge: 0
        },
        fallbackInterval: 25000,
        maxSilence: 30000,
    });
}


//document.addEventListener("DOMContentLoaded", () => {
    startValidate();
//});
</script>
</head>
<body>
<div>
  count: <span id="count"></span>
</div>
<div>
  lat: <span id="lat"></span>
</div>
<div id="lng">
  lnd: <span id="lnd"></span>
</div>
<hr>
<div id="error">
</div>
</body>
</html>
