<html>
<head>
<title>Sample of watchPosition 2</title>
<script>
function initGeolocationWatcher(userOptions = {}) {
  const sec = 1000;
  const options = {
    geoOptions: { enableHighAccuracy: true, timeout: 10 * sec },
    fallbackInterval: 30 * sec,
    maxSilence: 60 * sec,
    onUpdate: () => {},
    onError: () => {},
    domContentFallback: true,
    ...userOptions,
  };

  let watchId = null;
  let timerId = null;
  let lastUpdated = 0;

  function start() {
    if (watchId !== null) navigator.geolocation.clearWatch(watchId);

    watchId = navigator.geolocation.watchPosition(
      pos => {
        lastUpdated = Date.now();
        options.onUpdate(pos);
      },
      err => {
        options.onError(err);
        promptRecovery();
      },
      options.geoOptions
    );

    if (!timerId) {
      timerId = setInterval(checkSilence, options.fallbackInterval);
    }
  }

  function stop() {
    if (watchId !== null) navigator.geolocation.clearWatch(watchId);
    watchId = null;

    if (timerId !== null) clearInterval(timerId);
    timerId = null;
  }

  function restart(reason = "再起動") {
    stop();
    start();
    console.info(`[GeolocationWatcher] ${reason}`);
  }

  function checkSilence() {
    if (Date.now() - lastUpdated > options.maxSilence) {
      restart("沈黙による再起動");
    }
  }

  function promptRecovery() {
    const ok = window.confirm("位置情報の取得に失敗しました。再開しますか？");
    if (ok) restart("ユーザー同意による再起動");
  }

  document.addEventListener("pointerdown", () => {
    if (Date.now() - lastUpdated > options.maxSilence) {
      restart("ユーザー操作による再起動");
    }
  });

  if (options.domContentFallback) {
    document.addEventListener("DOMContentLoaded", () => {
      start();
      setTimeout(() => {
        if (lastUpdated === 0) {
          showStartButton();
        }
      }, 5000);
    });
  }

  function showStartButton() {
    const btn = document.createElement("button");
    btn.textContent = "位置情報取得を開始";
    btn.onclick = () => {
      start();
      btn.remove();
    };
    document.body.appendChild(btn);
  }

  return { start, stop };
}

const geolocation = navigator.geolocation;
let count = 0;

const success = (position) => {
    const coords = position.coords;
    document.getElementById('count').innerHTML = count++;
    document.getElementById('lat').innerHTML = coords.latitude;
    document.getElementById('lnd').innerHTML = coords.longitude;
}
const error = () => {
    const error = document.getElementById("error");
    const div = document.createElement("div"); 
    div.textContent = count;
    error.insertBefore(div, error.querySelector("div"));
}

function startValidate(timeout)
{
    timeout = timeout || 5000;
    //disableAditItem();
    //areaInfo(Measuring, message_measuring);
    initGeolocationWatcher({
        onUpdate: success,
        onError: error,
        geoOptions: {
            enableHighAccuracy: false,
            timeout: timeout,
            maximumAge: 0
        }
    });
}


document.addEventListener("DOMContentLoaded", () => {
    startValidate();
});
</script>
</head>
<body>
<div>
  count: <span id="count"></span>
</div>
<div>
  lat: <span id="lat"></span>
</div>
<div id="lng">
  lnd: <span id="lnd"></span>
</div>
<hr>
<div id="error">
</div>
</body>
</html>
