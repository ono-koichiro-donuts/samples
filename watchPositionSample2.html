<html>
<head>
<title>Sample of watchPosition 2</title>
<script>
export function initGeolocationWatcher(userOptions = {}) {
  const options = {
    geoOptions: { enableHighAccuracy: true, timeout: 10000 },
    fallbackInterval: 20000,  // デフォルト20秒
    maxSilence: 60000,        // デフォルト1分
    onUpdate: () => {},
    onError: () => {},
    domContentFallback: true,
    ...userOptions,
  };

  let watchId = null;
  let timerId = null;
  let lastUpdated = 0;
  let needsRestart = false;

  function start() {
    if (watchId !== null) navigator.geolocation.clearWatch(watchId);

    watchId = navigator.geolocation.watchPosition(
      pos => {
        lastUpdated = Date.now();
        options.onUpdate(pos);
      },
      err => {
        options.onError(err);
        handleError(err);
      },
      options.geoOptions
    );

    if (!timerId) {
      timerId = setInterval(checkSilence, options.fallbackInterval);
    }

    console.info("[GeolocationWatcher] watchPosition started");
  }

  function stop() {
    if (watchId !== null) navigator.geolocation.clearWatch(watchId);
    watchId = null;

    if (timerId !== null) clearInterval(timerId);
    timerId = null;
  }

  function restart(reason = "再起動") {
    stop();
    start();
    console.info(`[GeolocationWatcher] ${reason}`);
  }

  function checkSilence() {
    if (Date.now() - lastUpdated > options.maxSilence) {
      needsRestart = true;
      console.info("[GeolocationWatcher] 沈黙検知: ユーザー操作による再起動を待機中");
    }
  }

  function handleError(err) {
    console.warn("[GeolocationWatcher] 位置情報エラー:", err);

    if (err.code === 1) {
      // PERMISSION_DENIED
      promptRecovery("位置情報の利用が拒否されました。再開しますか？");
    } else {
      // 一時的エラーの場合は復旧を期待して放置
      console.info("[GeolocationWatcher] 一時的エラー。watchは継続。");
    }
  }

  function promptRecovery(message) {
    const ok = window.confirm(message || "位置情報取得に失敗しました。再開しますか？");
    if (ok) restart("ユーザー同意による再起動");
  }

  // pointerdown による再起動（沈黙検知後のみ）
  document.addEventListener("pointerdown", () => {
    if (needsRestart) {
      restart("ユーザー操作による沈黙復旧");
      needsRestart = false;
    }
  });

  if (options.domContentFallback) {
    document.addEventListener("DOMContentLoaded", () => {
      start();
      // 5秒後も未更新なら UI fallback
      setTimeout(() => {
        if (lastUpdated === 0) showStartButton();
      }, 5000);
    });
  }

  function showStartButton() {
    const btn = document.createElement("button");
    btn.textContent = "位置情報取得を開始";
    btn.onclick = () => {
      start();
      btn.remove();
    };
    document.body.appendChild(btn);
  }

  return { start, stop };
}

const geolocation = navigator.geolocation;
let count = 0;

const success = (position) => {
    const coords = position.coords;
    document.getElementById('count').innerHTML = count++;
    document.getElementById('lat').innerHTML = coords.latitude;
    document.getElementById('lnd').innerHTML = coords.longitude;
}
const error = () => {
    const error = document.getElementById("error");
    const div = document.createElement("div"); 
    div.textContent = count;
    error.insertBefore(div, error.querySelector("div"));
}

function startValidate(timeout)
{
    timeout = timeout || 5000;
    //disableAditItem();
    //areaInfo(Measuring, message_measuring);
    initGeolocationWatcher({
        onUpdate: success,
        onError: error,
        geoOptions: {
            enableHighAccuracy: false,
            timeout: timeout,
            maximumAge: 0
        }
    });
}


document.addEventListener("DOMContentLoaded", () => {
    startValidate();
});
</script>
</head>
<body>
<div>
  count: <span id="count"></span>
</div>
<div>
  lat: <span id="lat"></span>
</div>
<div id="lng">
  lnd: <span id="lnd"></span>
</div>
<hr>
<div id="error">
</div>
</body>
</html>
